<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audit Log - mcp-guard</title>
    <link rel="stylesheet" href="/css/style.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1><span>mcp</span>-guard</h1>
            <nav>
                <a href="/">Dashboard</a>
                <a href="/audit" class="active">Audit Log</a>
                <a href="/rules">Rules</a>
            </nav>
        </header>

        <main>
            <div class="card">
                <div class="card-header">
                    <span class="card-title">Audit Log</span>
                </div>

                <div class="filters">
                    <input type="text" id="filter-server" placeholder="Server name">
                    <input type="text" id="filter-tool" placeholder="Tool name">
                    <label>
                        <input type="checkbox" id="filter-blocked"> Blocked only
                    </label>
                    <button class="btn" onclick="loadAudit()">Filter</button>
                </div>

                <div id="audit-table" hx-get="/api/audit?limit=50" hx-trigger="load" hx-swap="innerHTML">
                    <div class="loading">Loading audit log...</div>
                </div>
            </div>
        </main>
    </div>

    <script>
        function loadAudit() {
            const server = document.getElementById('filter-server').value;
            const tool = document.getElementById('filter-tool').value;
            const blocked = document.getElementById('filter-blocked').checked;

            let url = '/api/audit?limit=50';
            if (server) url += '&server=' + encodeURIComponent(server);
            if (tool) url += '&tool=' + encodeURIComponent(tool);
            if (blocked) url += '&blocked=true';

            htmx.ajax('GET', url, '#audit-table');
        }

        document.body.addEventListener('htmx:afterSwap', function(evt) {
            if (evt.detail.target.id === 'audit-table') {
                const data = JSON.parse(evt.detail.xhr.response);
                let html = `
                    <table>
                        <thead>
                            <tr>
                                <th>Timestamp</th>
                                <th>Server</th>
                                <th>Tool</th>
                                <th>Status</th>
                                <th>Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                if (data.entries && data.entries.length > 0) {
                    data.entries.forEach(entry => {
                        const status = entry.blocked
                            ? `<span class="status-blocked">Blocked</span>`
                            : `<span class="status-ok">OK</span>`;
                        const time = new Date(entry.timestamp).toLocaleString();

                        html += `
                            <tr>
                                <td>${escapeHtml(time)}</td>
                                <td>${escapeHtml(entry.server_name)}</td>
                                <td>${escapeHtml(entry.tool_name)}</td>
                                <td>${status}</td>
                                <td>${entry.duration_ms}ms</td>
                            </tr>
                        `;
                    });
                } else {
                    html += '<tr><td colspan="5" class="empty-state">No audit entries</td></tr>';
                }

                html += '</tbody></table>';
                html += `<div style="margin-top: 12px; color: var(--text-muted);">Total entries: ${data.total}</div>`;

                evt.detail.target.innerHTML = html;
            }
        });

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }
    </script>
</body>
</html>
